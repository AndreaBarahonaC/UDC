---
title: "Diseño Experimental"
author:
  - Miguel Flores
  - Andrea Barahona
  - Fabián Encarnación
  - Dario Quishpe
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cerulean
    toc: True
    toc_depth: 5
    toc_float:  
      collapsed: true       # Salga solo el título y cuando aplastas los subtitulos
      smooth_scroll: true
runtime: shiny
      
      # Introducción
      
      # ANOVA
      ## Para módulo de elasticidad
      ## Para resistencia a la tensión
      ## Para elongación a la rotura
      ## Para tenacidad
      
      # Prueba Duncan
      ## Para módulo de elasticidad
      ## Para resistencia a la tensión
      ## Para elongación a la rotura
      ## Para tenacidad
      
      # Prueba Fisher (LSD)
      ## Para módulo de elasticidad
      ## Para resistencia a la tensión
      ## Para elongación a la rotura
      ## Para tenacidad
      
      # Prueba TURKEY (HSD)
      ## Para módulo de elasticidad
      ## Para resistencia a la tensión
      ## Para elongación a la rotura
      ## Para tenacidad
      
      # Prueba Bonferroni
      ## Para módulo de elasticidad
      ## Para resistencia a la tensión
      ## Para elongación a la rotura
      ## Para tenacidad

      # Referencias
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(agricolae)
library(dplyr)
library(knitr)
library(apaTables)
library(radiant.data)
library(shiny)
library(tidyverse)
library(highcharter)
library(kableExtra)
library(car)

```

# Introducción

El propósito de este diseño experimental es investigar el impacto de los factores de tamiz y temperatura en cuatro características mecánicas de las probetas: 

- El módulo de elasticidad (MPa),
- La resistencia a la tensión (MPa), 
- La elongación a la rotura ($\%$) y 
- La tenacidad (MPa). 

Se llevará a cabo un análisis de varianza (ANOVA) multifactorial para analizar cómo estos factores interactúan entre sí y con la variable dependiente, con el fin de determinar si tienen un efecto significativo en cada una de las características de las probetas. Los resultados obtenidos permitirán identificar los factores que optimizan cada una de las características mecánicas mencionadas.

Es crucial aclarar algunos términos y sus respectivas codificaciones que se utilizarán a lo largo del análisis:

1. **Tamiz**: Se refiere al tamaño de malla utilizado en el experimento:
  - `ST`: Sin Tamiz
  - `T20`: Tamiz con malla no.20
  - `T30`: Tamiz con malla no.30
  - `T40`: Tamiz con malla no.40

3. **Temperatura (Detallar)**:
  - Detallar temperatura

Este análisis detallado y sistemático permitirá una comprensión profunda de la relación entre los factores de interés y las características mecánicas de las probetas, lo que a su vez facilitará la selección de los factores óptimos para mejorar dichas características.

# Ingreso de la información

```{r echo=FALSE, warning=FALSE}

fileInput('file_experimento', 'Seleccione el archivo .xlsx', accept = c(".xlsx"))
div(tableOutput("carga_experimento"), style = "font-size:70%")
tableOutput("archivo_experimento")
output$archivo_experimento <- renderTable(input$file_experimento)
carga_experimento_aux <- function(inFile){
      if(is.null(inFile))
            return(paste("Ingrese un archivo Valido"))
      
  file.rename(inFile$datapath, paste(inFile$datapath, ".xlsx", sep=""))
      res <- read_excel(paste(inFile$datapath, ".xlsx", sep=""), 2)
      
      res_general <- read_excel(paste(inFile$datapath, ".xlsx", sep=""), 1)
      res_general<-tidyr::fill(res_general,Temperatura)
      res<-merge(res_general, res, by = c("Temperatura", "No. malla"))
      base_final<-res
      colnames(base_final)[colnames(base_final)]
      colnames(base_final)[colnames(base_final) == "Módulo elástico (MPa)"] <- "Mod_elas"
      colnames(base_final)[colnames(base_final) == "Resistencia a la tensión (MPa)"] <- "Resistencia"
      colnames(base_final)[colnames(base_final) == "Elongación a la rotura (%)"] <- "Elongacion"
      colnames(base_final)[colnames(base_final) == "Tenacidad (MPa)"] <- "Tenacidad"
      base_final |> mutate(Temperatura=as.character(Temperatura),`No. malla`=as.character(`No. malla`))
      return(base_final)
}
output$carga_experimento <- function(){
  inFile <- input$file_experimento
  res<-carga_experimento_aux(inFile)
  res %>%
            kbl(booktabs = TRUE) %>%
            kable_styling(full_width = F, bootstrap_options = c("condensed"), font_size = 11) %>%
            row_spec(0, background = "#33639f", color = "#ffffff") %>%
            scroll_box(width = "500px", height = "350px")
}


```


```{r eval=FALSE, include=FALSE}

# prueba1<-read_excel(path = "Propiedades mecanicas Raquis-Vinil AcrilicaVAE.xlsx",1)
# prueba2<-read_excel(path = "Propiedades mecanicas Raquis-Vinil AcrilicaVAE.xlsx",2)
# prueba1<-tidyr::fill(prueba1,colnames(prueba1)[2])
# 
# resp<-merge(prueba1, prueba2, by = c(colnames(prueba1)[2], colnames(prueba1)[3]))
# colnames(resp)[colnames(resp) == "Módulo elástico (MPa)"] <- "Mod_elas"
# colnames(resp)[colnames(resp) == "Resistencia a la tensión (MPa)"] <- "Resistencia"
# colnames(resp)[colnames(resp) == "Elongación a la rotura (%)"] <- "Elongacion"
# colnames(resp)[colnames(resp) == "Tenacidad (MPa)"] <- "Tenacidad"
# unique(resp[["No. malla"]])
# modelo_modu <- aov(Mod_elas ~ `Temperatura` * `No. malla`, data = resp)
# summary(modelo_modu)
# tabla1 <- LSD.test(modelo_modu,c("No. malla","Temperatura"),group = FALSE, p.adj = 'bon')$comparison
# tabla1<-rownames_to_column(tabla1,var='Combinaciones')
# tabla1<-tabla1 %>% select(-signif.)
# tabla1<-tabla1 %>% mutate(Etiqueta=Combinaciones)%>% separate(Combinaciones,into=c('Malla 1','Temperatura 1',"Malla 2","Temperatura 2"),sep="[:\\-]")
# tabla1$`Temperatura 1`<-trimws(tabla1$`Temperatura 1`)
# tabla1$`Malla 2`<-trimws(tabla1$`Malla 2`)
# tabla1<-tabla1 %>% rename(Diferencia=difference,`Valor-p`=pvalue)
# 
# 
# #Prueba filtro
# tamiz<-'20'
# temp<-'100'
#   if(tamiz=='-'){
#     tamiz<-c('ST','20','30','40')
#   }
#   if(temp=='-'){
#     fibra<-c('80','100','120','140','160')
#   }
#   tabla1<-tabla1 %>% filter(`Malla 1`%in%tamiz,`Malla 2`%in%tamiz)

```

```{r eval=FALSE, include=FALSE}
base_f<-reactive({
  inFile<-input$file_experimento
  tabla<-carga_experimento_aux(inFile)
  tabla
  })
renderTable({base_f()})
```



# Pruebas

```{r,echo=FALSE}
selectInput('prop','Seleccione la Propiedad',selected='Mod_elas', choices = c('Mod_elas','Resistencia','Elongacion','Tenacidad'))
selectInput('test','Seleccione el test',selected = 'Bonferroni', choices = c('Bonferroni','Duncan','Fisher','Tukey'))
selectInput('tamiz1','Seleccione el Tamiz',
              choices=c('-','ST','20','30','40'),selected = '-')
selectInput('temp1','Seleccione la Temperatura',
              choices=c('-','80','100','120','140','160'),selected = '-')
selectInput('difsig1','Diferencia significativa',
              choices=c('-','Sí','No'),selected = '-')
observe({
      req(input$file_experimento)
      inFile<-input$file_experimento
      tabla<-carga_experimento_aux(inFile)
      new_choices <- c('-',unique(tabla$Temperatura))
      updateSelectInput(session, inputId = "temp1", choices = new_choices)
    })
#Tabla filtros
tabla1 <- reactive({
  inFile<-input$file_experimento
  tabla<-carga_experimento_aux(inFile)
  modelo_modu <- aov(tabla[[input$prop]] ~ `Temperatura` * `No malla`, data = tabla)
  tabla1 <- LSD.test(modelo_modu,c("No. malla","Temperatura"),group = FALSE, adj = 'bon')$comparison
  if (input$test=='Duncan') {
    tabla1 <- duncan.test(modelo_modu,c("No. malla","Temperatura"),group = FALSE)$comparison
  }
  else if(input$test=='Fisher'){
    tabla1 <- LSD.test(modelo_modu,c("No. malla","Temperatura"),group = FALSE)$comparison
  }
  else if(input$test=='Tukey'){
    tabla1 <- HSD.test(modelo_modu,c("No. malla","Temperatura"),group = FALSE)$comparison
  }
  else{
    tabla1 <- LSD.test(modelo_modu,c("No. malla","Temperatura"),group = FALSE, adj = 'bon')$comparison
  }
  tabla1<-rownames_to_column(tabla1,var='Combinaciones')
  tabla1<-tabla1 %>% select(-signif.)
  tabla1<-tabla1 %>% mutate(Etiqueta=Combinaciones)%>% separate(Combinaciones,into=c('Malla 1','Temperatura 1',"Malla 2","Temperatura 2"),sep="[:\\-]")
  tabla1$`Temperatura 1`<-trimws(tabla1$`Temperatura 1`)
  tabla1$`Malla 2`<-trimws(tabla1$`Malla 2`)
  tabla1<-tabla1 %>% rename(Diferencia=difference,`Valor-p`=pvalue)
  #FILTRO
  tamiz<-input$tamiz1
  temp<-input$temp1
  if(tamiz=='-'){
    tamiz<-c('ST','20','30','40')
  }
  if(temp=='-'){
    temp<-c(unique(tabla$Temperatura))
  }
  tabla1<-tabla1 %>% filter(`Malla 1`%in%tamiz,`Malla 2`%in%tamiz,`Temperatura 1`%in%tem,`Temperatura 2`%in%temp)
  if (input$difsig1=="Sí") {
    tabla1<-tabla1%>% filter(`Valor-p`<0.05)
  }
  else if (input$difsig1=="No") {
    tabla1<-tabla1 %>% filter(`Valor-p`>=0.05)
  }
  tabla1
    
})
  
renderTable({tabla1() %>% select(-Etiqueta)})
   
#Grafico con filtros

renderHighchart({
  hc <- hchart(tabla1(),
               type = "scatter",
               hcaes(x = Etiqueta,
                     y = `Valor-p`)) %>%
    hc_title(
      text = "Valores p",
      style = list(fontWeight = "bold", fontSize = "25px"),
      align = "center"
    ) %>% hc_tooltip(headerFormat = "<br>", pointFormat = "Etiqueta: {point.Etiqueta}<br>Valor-p {series.Etiqueta}: {point.Valor-p}") %>%
    hc_yAxis(
      gridLineColor = "transparent",
      min = 0,
      max = 1,
      opposite = FALSE,
      alternateGridColor = "#FAFAFA",
      plotBands = list(list(
        from = 0.05,
        to = 1,
        color = "#FFC6C6",
        label = list(text = "Dif. no significativa")
      )),
      # Agregar línea en el eje y = 0.05
      plotLines = list(
        list(
          color = "red",
          width = 2,
          value = 0.05,
          dashStyle = "dash",
          zIndex = 5,
          label = list(
            text = "0.05",
            align = "right",
            style = list(color = "red")
          )
        )
      )
    ) %>% hc_xAxis(labels = list(enabled = FALSE))
}) 
  



```



# Referencias

*Box, G.E.; Hunter, J.S.; Hunter, W.G. (2008). Estadística para investigadores. Diseño, innovación y descubrimiento. Segunda Edición, Ed. Reverté, Barcelona.*

*Gutiérrez, H.; de la Vara, R. (2003). Análisis y diseño de experimentos. McGraw-Hill, México.*

*Lara, A.P (2020). Diseño estadístico de experimentos. Análisis de la varianza. Grupo Editorial Universitario. Universidad de Granada, España*

*Walpole, R. E., Myers, R. H., & Myers, S. L. KY (2012). Probabilidad y estadística para ingeniería y ciencias.*


